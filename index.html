<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Value Estimator Chatbot</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    #chat-box { background: white; padding: 20px; border-radius: 10px; height: 400px; overflow-y: auto; margin-bottom: 10px; }
    .message { margin-bottom: 10px; }
    .user { color: blue; }
    .bot { color: green; }
    input { width: 80%; padding: 10px; margin-right: 10px; }
    button { padding: 10px 15px; }
  </style>
</head>
<body>
  <h1>Car Value Estimator Chatbot</h1>
  <div id="root"></div>

  <script type="text/babel">
    function Chatbot() {
      const [messages, setMessages] = React.useState([
        { type: 'bot', text: 'Hi! Let\'s estimate your car value. Please select the make.' }
      ]);
      const [input, setInput] = React.useState("");
      const [carDetails, setCarDetails] = React.useState({});
      const [step, setStep] = React.useState(0);
      const [makes, setMakes] = React.useState([]);
      const [models, setModels] = React.useState([]);
      const [years, setYears] = React.useState([]);
      const [selectedMake, setSelectedMake] = React.useState('');
      const [selectedModel, setSelectedModel] = React.useState('');
      const [selectedYear, setSelectedYear] = React.useState('');
  
      const steps = ["make", "model", "year", "mileage", "condition"];
  
      React.useEffect(() => {
        fetch("https://www.carqueryapi.com/api/0.3/?cmd=getMakes")
          .then(res => res.json())
          .then(data => {
            const sortedMakes = data.Makes.sort((a, b) => a.make_display.localeCompare(b.make_display));
            setMakes(sortedMakes);
          });
      }, []);
  
      React.useEffect(() => {
        if (selectedMake) {
          fetch(`https://www.carqueryapi.com/api/0.3/?cmd=getModels&make=${selectedMake}&sold_in_us=1`)
            .then(res => res.json())
            .then(data => {
              const sortedModels = data.Models.sort((a, b) => a.model_name.localeCompare(b.model_name));
              setModels(sortedModels);
            });
        }
      }, [selectedMake]);
  
      React.useEffect(() => {
        const currentYear = new Date().getFullYear();
        const yearsArray = Array.from({ length: 30 }, (_, i) => currentYear - i);
        setYears(yearsArray);
      }, []);
  
      const handleSend = async () => {
        if (step === 0 && selectedMake) {
          setCarDetails({ ...carDetails, make: selectedMake });
          setMessages([...messages, { type: 'user', text: selectedMake }, { type: 'bot', text: 'Now select the model.' }]);
          setStep(1);
        } else if (step === 1 && selectedModel) {
          setCarDetails({ ...carDetails, model: selectedModel });
          setMessages([...messages, { type: 'user', text: selectedModel }, { type: 'bot', text: 'Choose the year.' }]);
          setStep(2);
        } else if (step === 2 && selectedYear) {
          setCarDetails({ ...carDetails, year: selectedYear });
          setMessages([...messages, { type: 'user', text: selectedYear }, { type: 'bot', text: 'Enter mileage (in km).' }]);
          setStep(3);
        } else if (step === 3 && input.trim()) {
          setCarDetails({ ...carDetails, mileage: input.trim() });
          setMessages([...messages, { type: 'user', text: input.trim() }, { type: 'bot', text: 'What is the condition? (Excellent, Good, Fair)' }]);
          setInput('');
          setStep(4);
        } else if (step === 4 && input.trim()) {
          const condition = input.trim();
          const finalDetails = { ...carDetails, condition };
  
          setMessages([...messages, { type: 'user', text: condition }, { type: 'bot', text: 'Estimating value...' }]);
          setInput('');
  
          const res = await fetch('http://localhost:5000/estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalDetails)
          });
  
          const data = await res.json();
  
          setMessages([
            ...messages,
            { type: 'user', text: condition },
            { type: 'bot', text: `Estimated car value is â‚¹${data.estimated_value}` },
            { type: 'bot', text: 'Want to estimate another car? Start by selecting the make again.' }
          ]);
          setCarDetails({});
          setStep(0);
          setSelectedMake('');
          setSelectedModel('');
          setSelectedYear('');
        }
      };
  
      return (
        <div>
          <div id="chat-box">
            {messages.map((msg, idx) => (
              <p key={idx} className={`message ${msg.type}`}>
                <strong>{msg.type === 'user' ? 'You' : 'Bot'}:</strong> {msg.text}
              </p>
            ))}
          </div>
  
          {step === 0 && (
            <select value={selectedMake} onChange={(e) => setSelectedMake(e.target.value)}>
              <option value="">Select Make</option>
              {makes.map(make => (
                <option key={make.make_id} value={make.make_slug}>{make.make_display}</option>
              ))}
            </select>
          )}
  
          {step === 1 && (
            <select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)}>
              <option value="">Select Model</option>
              {models.map(model => (
                <option key={model.model_name} value={model.model_name}>{model.model_name}</option>
              ))}
            </select>
          )}
  
          {step === 2 && (
            <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>
              <option value="">Select Year</option>
              {years.map(y => (
                <option key={y} value={y}>{y}</option>
              ))}
            </select>
          )}
  
          {step >= 3 && (
            <>
              <input
                type="text"
                value={input}
                placeholder={step === 3 ? "Enter mileage in km" : "Enter condition"}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSend()}
              />
              <button onClick={handleSend}>Send</button>
            </>
          )}
  
          {(step === 0 || step === 1 || step === 2) && (
            <button onClick={handleSend}>Next</button>
          )}
        </div>
      );
    }
  
    ReactDOM.render(<Chatbot />, document.getElementById('root'));
  </script>
  
</body>
</html>
